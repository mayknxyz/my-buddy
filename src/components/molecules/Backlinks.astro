---
import { existsSync, readFileSync } from 'node:fs';
import { resolve } from 'node:path';
import Badge from '../atoms/Badge.astro';

interface Props {
  slug: string;
}

interface BacklinkSource {
  slug: string;
  collection: string;
  displayName: string;
  url: string;
}

const { slug } = Astro.props;

const indexPath = resolve(process.cwd(), 'src/data/backlink-index.json');
let backlinks: BacklinkSource[] = [];

if (existsSync(indexPath)) {
  const index: Record<string, BacklinkSource[]> = JSON.parse(readFileSync(indexPath, 'utf-8'));
  backlinks = index[slug] ?? [];
}

const collectionVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  accounts: 'info',
  contacts: 'neutral',
  projects: 'warning',
  deals: 'success',
  tasks: 'neutral',
  kb: 'info',
  meetings: 'neutral',
  journals: 'neutral',
};
---

{backlinks.length > 0 && (
  <div class="border-t border-[var(--color-border)] pt-6 mt-6">
    <h3 class="text-sm font-medium text-[var(--color-text-muted)] mb-3">Referenced by</h3>
    <div class="space-y-2">
      {backlinks.map((bl) => (
        <div class="flex items-center gap-2 text-sm">
          <Badge variant={collectionVariants[bl.collection] ?? 'neutral'}>
            {bl.collection}
          </Badge>
          <a
            href={bl.url}
            class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline"
            data-focusable
            tabindex="0"
          >
            {bl.displayName}
          </a>
        </div>
      ))}
    </div>
  </div>
)}
