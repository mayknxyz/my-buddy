---
import { getCollection, render } from 'astro:content';
import Badge from '../../components/atoms/Badge.astro';
import Backlinks from '../../components/molecules/Backlinks.astro';
import PageTemplate from '../../components/templates/PageTemplate.astro';
import { displayName } from '../../utils/display';

export async function getStaticPaths() {
  const accounts = await getCollection('accounts');
  return accounts.map(account => ({
    params: { slug: account.id },
    props: { account },
  }));
}

const { account } = Astro.props;
const { Content } = await render(account);

const statusVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  active: 'success',
  inactive: 'neutral',
  potential: 'info',
};

const typeVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  lead: 'warning',
  client: 'success',
};

const title = displayName(account);

// Get related entities
const allContacts = await getCollection('contacts');
const allDeals = await getCollection('deals');
const allProjects = await getCollection('projects');
const allMeetings = await getCollection('meetings');

const contacts = allContacts.filter(c => c.data.account.id === account.id);
const deals = allDeals.filter(d => d.data.account.id === account.id);
const projects = allProjects.filter(p => p.data.account.id === account.id);
const meetings = allMeetings.filter(m => m.data.account?.id === account.id);

const stageVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  discovery: 'info',
  proposal: 'warning',
  negotiation: 'warning',
  'closed-won': 'success',
  'closed-lost': 'danger',
};

const projectStatusVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  planning: 'info',
  'in-progress': 'warning',
  done: 'success',
  paused: 'neutral',
};

let globalIndex = 0;
---

<PageTemplate
  title={title}
  breadcrumbs={[
    { label: 'Accounts', href: '/accounts/' },
    { label: title, href: `/accounts/${account.id}/` },
  ]}
>
  <meta data-pagefind-filter="collection[content]" content="accounts" />
  <span data-pagefind-meta="title" style="display:none;">{displayName(account)}</span>
  <div class="max-w-4xl space-y-6">
    <div class="flex flex-wrap items-center gap-3 text-sm text-[var(--color-text)]">
      <Badge variant={typeVariants[account.data.type]}>{account.data.type}</Badge>
      <Badge variant={statusVariants[account.data.status]}>{account.data.status}</Badge>
      <span>Since: {account.data.since.toISOString().split('T')[0]}</span>
    </div>

    <div class="border-t border-[var(--color-border)] pt-4">
      <h3 class="text-sm font-medium text-[var(--color-text-muted)] mb-2">Contact</h3>
      <p class="text-[var(--color-text)]">{account.data.contact}</p>
    </div>

    <!-- Contacts -->
    {contacts.length > 0 && (
      <div class="border-t border-[var(--color-border)] pt-4">
        <h3 class="text-sm font-medium text-[var(--color-text-muted)] mb-2">Contacts</h3>
        <div class="rounded-lg border border-[var(--color-border)] overflow-hidden">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-[var(--color-surface)] text-left text-[var(--color-text-muted)]">
                <th class="py-2 px-4 font-medium">ID</th>
                <th class="py-2 px-4 font-medium">First Name</th>
                <th class="py-2 px-4 font-medium">Last Name</th>
                <th class="py-2 px-4 font-medium">Role</th>
                <th class="py-2 px-4 font-medium">Email</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-[var(--color-border)]">
              {contacts.map((contact) => {
                const idx = globalIndex++;
                return (
                  <tr class="hover:bg-[var(--color-surface-hover)] transition-colors">
                    <td class="py-2 px-4 text-[var(--color-text-muted)]">{contact.data.uid}</td>
                    <td class="py-2 px-4">
                      <a
                        href={`/contacts/${contact.id}/`}
                        class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline"
                        data-focusable
                        data-index={idx}
                        tabindex="0"
                      >
                        {contact.data.first_name}
                        {contact.data.is_primary && <span class="text-xs text-[var(--color-text-muted)] ml-1">(primary)</span>}
                      </a>
                    </td>
                    <td class="py-2 px-4 text-[var(--color-text)]">{contact.data.last_name}</td>
                    <td class="py-2 px-4 text-[var(--color-text)]">{contact.data.role || '-'}</td>
                    <td class="py-2 px-4 text-[var(--color-text)]">{contact.data.email || '-'}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    )}

    <!-- Deals -->
    {deals.length > 0 && (
      <div class="border-t border-[var(--color-border)] pt-4">
        <h3 class="text-sm font-medium text-[var(--color-text-muted)] mb-2">Deals</h3>
        <div class="rounded-lg border border-[var(--color-border)] overflow-hidden">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-[var(--color-surface)] text-left text-[var(--color-text-muted)]">
                <th class="py-2 px-4 font-medium">ID</th>
                <th class="py-2 px-4 font-medium">Deal</th>
                <th class="py-2 px-4 font-medium">Stage</th>
                <th class="py-2 px-4 font-medium">Value</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-[var(--color-border)]">
              {deals.map((deal) => {
                const idx = globalIndex++;
                return (
                  <tr class="hover:bg-[var(--color-surface-hover)] transition-colors">
                    <td class="py-2 px-4 text-[var(--color-text-muted)]">{deal.data.uid}</td>
                    <td class="py-2 px-4">
                      <a
                        href={`/deals/${deal.id}/`}
                        class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline"
                        data-focusable
                        data-index={idx}
                        tabindex="0"
                      >
                        {deal.id.replace(/-/g, ' ')}
                      </a>
                    </td>
                    <td class="py-2 px-4">
                      <Badge variant={stageVariants[deal.data.stage]}>{deal.data.stage}</Badge>
                    </td>
                    <td class="py-2 px-4 text-[var(--color-text)]">
                      {deal.data.value ? `$${deal.data.value.toLocaleString()}` : '-'}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    )}

    <!-- Projects -->
    {projects.length > 0 && (
      <div class="border-t border-[var(--color-border)] pt-4">
        <h3 class="text-sm font-medium text-[var(--color-text-muted)] mb-2">Projects</h3>
        <div class="rounded-lg border border-[var(--color-border)] overflow-hidden">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-[var(--color-surface)] text-left text-[var(--color-text-muted)]">
                <th class="py-2 px-4 font-medium">ID</th>
                <th class="py-2 px-4 font-medium">Project</th>
                <th class="py-2 px-4 font-medium">Status</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-[var(--color-border)]">
              {projects.map((project) => {
                const idx = globalIndex++;
                return (
                  <tr class="hover:bg-[var(--color-surface-hover)] transition-colors">
                    <td class="py-2 px-4 text-[var(--color-text-muted)]">{project.data.uid}</td>
                    <td class="py-2 px-4">
                      <a
                        href={`/projects/${project.id}/`}
                        class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline"
                        data-focusable
                        data-index={idx}
                        tabindex="0"
                      >
                        {displayName(project)}
                      </a>
                    </td>
                    <td class="py-2 px-4">
                      <Badge variant={projectStatusVariants[project.data.status]}>{project.data.status}</Badge>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    )}

    <!-- Meetings -->
    {meetings.length > 0 && (
      <div class="border-t border-[var(--color-border)] pt-4">
        <h3 class="text-sm font-medium text-[var(--color-text-muted)] mb-2">Meetings</h3>
        <div class="space-y-2">
          {meetings.map((meeting) => {
            const idx = globalIndex++;
            return (
              <a
                href={`/meetings/${meeting.id}/`}
                class="block p-3 rounded-lg bg-[var(--color-surface)] hover:bg-[var(--color-surface-hover)] transition-colors text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline text-sm"
                data-focusable
                data-index={idx}
                tabindex="0"
              >
                {meeting.id.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/-/g, ' ')}
                <span class="text-[var(--color-text-muted)] ml-2">{meeting.data.date.toISOString().split('T')[0]}</span>
              </a>
            );
          })}
        </div>
      </div>
    )}

    <div class="border-t border-[var(--color-border)] pt-6 prose prose-invert max-w-none">
      <Content />
    </div>

    <Backlinks slug={account.id} />
  </div>
</PageTemplate>
