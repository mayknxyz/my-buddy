---
/**
 * Clients list page.
 * Displays all clients with status filter, sorted active-first then alphabetical.
 */
import BaseLayout from "@/components/templates/BaseLayout.astro";
import PageHeader from "@/components/templates/PageHeader.astro";
import Badge from "@/components/atoms/Badge.astro";
import FilterSelect from "@/components/atoms/FilterSelect.astro";
import FilterBar from "@/components/molecules/FilterBar.astro";
import EmptyState from "@/components/molecules/EmptyState.astro";
import { statusVariant, clientSlugFromId } from "@/lib/format";
import { getCollection } from "astro:content";

const statusFilter = Astro.url.searchParams.get("status");

const allClients = await getCollection("clients").catch(() => []);

// WHY: Count projects per client for the list display
const allProjects = await getCollection("projects").catch(() => []);
const projectCountByClient = new Map<string, number>();
for (const p of allProjects) {
  const client = p.data.client;
  if (client) {
    projectCountByClient.set(client, (projectCountByClient.get(client) ?? 0) + 1);
  }
}

// Filter by status
let clients = statusFilter
  ? allClients.filter((c) => c.data.status === statusFilter)
  : allClients;

// Sort: active first, then alphabetical
const statusOrder: Record<string, number> = { active: 0, inactive: 1, churned: 2 };
clients = clients.sort((a, b) => {
  const orderDiff = (statusOrder[a.data.status] ?? 9) - (statusOrder[b.data.status] ?? 9);
  if (orderDiff !== 0) return orderDiff;
  return a.data.name.localeCompare(b.data.name);
});

const statusOptions = [
  { value: "active", label: "Active" },
  { value: "inactive", label: "Inactive" },
  { value: "churned", label: "Churned" },
];
---

<BaseLayout title="Clients â€” my-buddy">
  <main class="mx-auto max-w-6xl p-6">
    <PageHeader title="Clients" count={clients.length} breadcrumbs={[{ label: "Home", href: "/" }, { label: "Clients" }]}>
      <FilterBar>
        <FilterSelect name="status" label="Status" options={statusOptions} selected={statusFilter ?? undefined} />
      </FilterBar>
    </PageHeader>

    {clients.length === 0 ? (
      <EmptyState title="No clients found" description={statusFilter ? "Try changing the filter." : "Add your first client to get started."} />
    ) : (
      <div class="space-y-1">
        {clients.map((client) => {
          const slug = clientSlugFromId(client.id);
          const projectCount = projectCountByClient.get(slug) ?? 0;
          return (
            <a
              href={`/clients/${slug}`}
              data-navigable
              class="flex items-center justify-between rounded-lg border border-transparent px-4 py-3 hover:border-border hover:bg-surface-1"
            >
              <div class="flex items-center gap-4">
                <div>
                  <span class="font-medium">{client.data.name}</span>
                  {client.data.industry && (
                    <span class="ml-2 text-sm text-text-muted">{client.data.industry}</span>
                  )}
                </div>
              </div>
              <div class="flex items-center gap-4">
                {projectCount > 0 && (
                  <span class="text-sm text-text-muted">
                    {projectCount} project{projectCount !== 1 ? "s" : ""}
                  </span>
                )}
                <Badge variant={statusVariant(client.data.status)}>{client.data.status}</Badge>
              </div>
            </a>
          );
        })}
      </div>
    )}
  </main>
</BaseLayout>
