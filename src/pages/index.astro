---
/**
 * Dashboard home page.
 * Displays summary widgets using cross-collection queries from relations.ts.
 */
import BaseLayout from "@/components/templates/BaseLayout.astro";
import DashboardWidget from "@/components/molecules/DashboardWidget.astro";
import { loadConfig } from "@/lib/config";
import { formatCurrency } from "@/lib/format";
import { getCollection } from "astro:content";
import { getInvoiceSummary, getExpiringAssets, getOpportunityPipeline, getPinnedItems } from "@/lib/relations";

const config = await loadConfig();

// Fetch all needed collections in parallel
const [
  projects,
  allTasks,
  allMeetings,
  allInteractions,
  allTimelog,
  allLeads,
] = await Promise.all([
  getCollection("projects").catch(() => []),
  getCollection("tasks").catch(() => []),
  getCollection("meetings").catch(() => []),
  getCollection("interactions").catch(() => []),
  getCollection("timelog").catch(() => []),
  getCollection("leads").catch(() => []),
]);

// Active projects
const activeProjects = projects.filter((p) => p.data.status === "active");

// Tasks due this week + overdue detection
const now = new Date();
const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
const weekEnd = new Date(now);
weekEnd.setDate(weekEnd.getDate() + (7 - weekEnd.getDay()));
const tasksDueThisWeek = allTasks.filter((t) => {
  if (t.data.status === "done") return false;
  const due = t.data.due;
  return due && new Date(due) <= weekEnd;
});

// WHY: precompute overdue IDs as a Set to avoid `<` comparisons in template
// expressions, which break the Astro compiler (interpreted as JSX tags)
const overdueTaskIds = new Set(
  allTasks
    .filter((t) => {
      if (t.data.status === "done") return false;
      const due = t.data.due;
      return due && new Date(due) < todayStart;
    })
    .map((t) => t.id),
);
const overdueTaskCount = overdueTaskIds.size;

// Invoice summary
const invoiceSummary = await getInvoiceSummary();
const unpaidTotal = invoiceSummary.sent.total + invoiceSummary.overdue.total;
const unpaidCount = invoiceSummary.sent.count + invoiceSummary.overdue.count;

// Expiring assets (30 days)
const expiringAssets = await getExpiringAssets(30);

// Today's meetings
const todayStr = now.toISOString().slice(0, 10);
const todaysMeetings = allMeetings.filter(
  (m) => new Date(m.data.date).toISOString().slice(0, 10) === todayStr
);

// Recent interactions (last 7 days)
const weekAgo = new Date(now);
weekAgo.setDate(weekAgo.getDate() - 7);
const recentInteractions = allInteractions
  .filter((i) => new Date(i.data.date) >= weekAgo)
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 5);

// Pipeline summary
const pipeline = await getOpportunityPipeline();
const activeLeads = allLeads.filter(
  (l) => l.data.status !== "disqualified"
).length;
const activeOpps = pipeline
  .filter((s) => !["closed-won", "closed-lost"].includes(s.stage))
  .reduce((sum, s) => sum + s.opportunities.length, 0);
const pipelineValue = pipeline
  .filter((s) => !["closed-won", "closed-lost"].includes(s.stage))
  .reduce((sum, s) => sum + s.totalValue, 0);

// Time logged this week
const weekStart = new Date(now);
weekStart.setDate(weekStart.getDate() - weekStart.getDay());
const timeThisWeek = allTimelog
  .filter((t) => new Date(t.data.date) >= weekStart)
  .reduce((sum, t) => sum + t.data.hours, 0);

// Pinned items
const pinnedItems = await getPinnedItems();

---

<BaseLayout title={`${config.instance.name} — Dashboard`}>
  <main class="mx-auto max-w-6xl p-6">
    <header class="mb-8">
      <h1 class="text-3xl font-bold">{config.instance.name}</h1>
      <p class="mt-1 text-text-secondary">{config.persona.greeting}</p>
    </header>

    {pinnedItems.length > 0 && (
      <div class="mb-6">
        <h2 class="mb-3 text-sm font-medium uppercase tracking-wide text-text-muted">Pinned</h2>
        <div class="flex flex-wrap gap-2">
          {pinnedItems.map((item) => (
            <a
              href={item.href}
              class="inline-flex items-center gap-2 rounded-lg border border-border bg-surface-1 px-3 py-2 text-sm hover:border-border-hover hover:bg-surface-2"
            >
              <span class="text-xs text-text-muted">{item.collection}</span>
              <span class="font-medium">{item.title}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      {/* Row 1: Key metrics */}
      <DashboardWidget title="Active Projects" value={activeProjects.length} href="/projects">
        {activeProjects.length > 0 && (
          <ul class="space-y-0.5">
            {activeProjects.slice(0, 3).map((p) => (
              <li class="truncate">{p.data.title}</li>
            ))}
            {activeProjects.length > 3 && (
              <li class="text-text-muted">+{activeProjects.length - 3} more</li>
            )}
          </ul>
        )}
      </DashboardWidget>

      <DashboardWidget title="Tasks Due This Week" value={tasksDueThisWeek.length} href="/tasks">
        {overdueTaskCount > 0 && (
          <span class="text-danger text-xs font-medium">{overdueTaskCount} overdue</span>
        )}
        {tasksDueThisWeek.length > 0 && (
          <ul class="space-y-0.5">
            {tasksDueThisWeek.slice(0, 3).map((t) => (
              <li class={`truncate ${overdueTaskIds.has(t.id) ? "text-danger" : ""}`}>
                <span class={`mr-1.5 inline-block h-1.5 w-1.5 rounded-full ${
                  overdueTaskIds.has(t.id) ? "bg-danger" :
                  t.data.priority === "high" ? "bg-danger" :
                  t.data.priority === "medium" ? "bg-warning" : "bg-info"
                }`} />
                {t.data.title}
              </li>
            ))}
          </ul>
        )}
      </DashboardWidget>

      <DashboardWidget
        title="Unpaid Invoices"
        value={unpaidCount > 0 ? formatCurrency(unpaidTotal) : "$0"}
        href="/invoices"
      >
        {unpaidCount > 0 && (
          <span>{unpaidCount} invoice{unpaidCount !== 1 ? "s" : ""} outstanding</span>
        )}
        {invoiceSummary.overdue.count > 0 && (
          <span class="text-danger"> ({invoiceSummary.overdue.count} overdue)</span>
        )}
      </DashboardWidget>

      <DashboardWidget title="Expiring Soon" value={expiringAssets.length} href="/assets">
        {expiringAssets.length > 0 ? (
          <ul class="space-y-0.5">
            {expiringAssets.slice(0, 3).map((a) => (
              <li class="truncate">
                <span class="text-warning">{a.type}</span> — {a.label}
              </li>
            ))}
          </ul>
        ) : (
          <span class="text-text-muted">Nothing expiring in 30 days</span>
        )}
      </DashboardWidget>

      {/* Row 2: Activity */}
      <DashboardWidget title="Today's Meetings" value={todaysMeetings.length} href="/meetings">
        {todaysMeetings.length > 0 ? (
          <ul class="space-y-0.5">
            {todaysMeetings.map((m) => (
              <li class="truncate">{m.data.title}</li>
            ))}
          </ul>
        ) : (
          <span class="text-text-muted">No meetings today</span>
        )}
      </DashboardWidget>

      <DashboardWidget title="Recent Interactions" value={recentInteractions.length} href="/interactions">
        {recentInteractions.length > 0 ? (
          <ul class="space-y-0.5">
            {recentInteractions.slice(0, 3).map((i) => (
              <li class="truncate">
                <span class="text-text-muted">{i.data.type}</span> — {i.data.title}
              </li>
            ))}
          </ul>
        ) : (
          <span class="text-text-muted">No recent interactions</span>
        )}
      </DashboardWidget>

      <DashboardWidget title="Pipeline" href="/opportunities">
        <div class="space-y-0.5">
          <div class="flex justify-between">
            <span>Leads</span>
            <span class="font-medium">{activeLeads}</span>
          </div>
          <div class="flex justify-between">
            <span>Opportunities</span>
            <span class="font-medium">{activeOpps}</span>
          </div>
          {pipelineValue > 0 && (
            <div class="mt-1 border-t border-border pt-1 flex justify-between">
              <span>Pipeline value</span>
              <span class="font-medium text-[var(--color-accent)]">{formatCurrency(pipelineValue)}</span>
            </div>
          )}
        </div>
      </DashboardWidget>

      <DashboardWidget title="Time This Week" value={`${timeThisWeek.toFixed(1)}h`} href="/timelog">
        {timeThisWeek > 0 ? (
          <span>Logged across all projects</span>
        ) : (
          <span class="text-text-muted">No time logged yet</span>
        )}
      </DashboardWidget>
    </div>

    <footer class="mt-8 text-center text-xs text-text-muted">
      Press <kbd class="rounded bg-surface-2 px-1.5 py-0.5 font-mono">?</kbd> for keyboard shortcuts
    </footer>
  </main>
</BaseLayout>
