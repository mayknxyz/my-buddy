---
import { getCollection, render } from 'astro:content';
import Badge from '../../components/atoms/Badge.astro';
import SiblingNav from '../../components/atoms/SiblingNav.astro';
import Backlinks from '../../components/molecules/Backlinks.astro';
import RelatedContent from '../../components/molecules/RelatedContent.astro';
import PageTemplate from '../../components/templates/PageTemplate.astro';
import { displayName } from '../../utils/display';

export async function getStaticPaths() {
  const tasks = await getCollection('tasks');
  return tasks.map(task => ({
    params: { slug: task.id },
    props: { task },
  }));
}

const { task } = Astro.props;
const { Content } = await render(task);

const projects = await getCollection('projects');
const accounts = await getCollection('accounts');
const projectEntry = projects.find(p => p.id === task.data.project.id);
const accountEntry = projectEntry ? accounts.find(a => a.id === projectEntry.data.account.id) : undefined;

const statusVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  todo: 'neutral',
  'in-progress': 'warning',
  done: 'success',
  blocked: 'danger',
};

const priorityVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  low: 'neutral',
  medium: 'info',
  high: 'warning',
  urgent: 'danger',
};

// Sibling task navigation
const priorityOrder: Record<string, number> = { urgent: 0, high: 1, medium: 2, low: 3 };
const allTasks = await getCollection('tasks');
const siblings = allTasks
  .filter(t => t.data.project.id === task.data.project.id)
  .sort((a, b) => {
    const pDiff = (priorityOrder[a.data.priority] ?? 3) - (priorityOrder[b.data.priority] ?? 3);
    if (pDiff !== 0) return pDiff;
    if (!a.data.due && !b.data.due) return 0;
    if (!a.data.due) return 1;
    if (!b.data.due) return -1;
    return a.data.due.getTime() - b.data.due.getTime();
  });

const currentIndex = siblings.findIndex(t => t.id === task.id);
const prevTask = currentIndex > 0 ? siblings[currentIndex - 1] : undefined;
const nextTask = currentIndex < siblings.length - 1 ? siblings[currentIndex + 1] : undefined;

const siblingItems = siblings
  .filter(t => t.id !== task.id)
  .map(t => ({
    label: t.id.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/-/g, ' '),
    href: `/tasks/${t.id}/`,
    badge: t.data.priority,
    badgeVariant: ({ low: 'neutral' as const, medium: 'info' as const, high: 'warning' as const, urgent: 'danger' as const })[t.data.priority],
    meta: t.data.due ? `Due: ${t.data.due.toISOString().split('T')[0]}` : undefined,
  }));

const title = task.id.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/-/g, ' ');

const prevLink = prevTask ? {
  label: prevTask.id.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/-/g, ' '),
  href: `/tasks/${prevTask.id}/`,
} : undefined;

const nextLink = nextTask ? {
  label: nextTask.id.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/-/g, ' '),
  href: `/tasks/${nextTask.id}/`,
} : undefined;

const breadcrumbs = [
  ...(accountEntry ? [
    { label: 'Accounts', href: '/accounts/' },
    { label: displayName(accountEntry), href: `/accounts/${accountEntry.id}/` },
  ] : []),
  ...(projectEntry ? [
    { label: 'Projects', href: '/projects/' },
    { label: displayName(projectEntry), href: `/projects/${projectEntry.id}/` },
  ] : []),
  { label: 'Tasks', href: '/tasks/' },
  { label: title, href: `/tasks/${task.id}/` },
];
---

<PageTemplate
  title={title}
  breadcrumbs={breadcrumbs}
>
  <meta data-pagefind-filter="collection[content]" content="tasks" />
  <span data-pagefind-meta="title" style="display:none;">{task.id.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/-/g, ' ')}</span>

  <SiblingNav prev={prevLink} next={nextLink} />

  <div class="max-w-4xl space-y-6">
    <div class="flex flex-wrap items-center gap-3 text-sm">
      <Badge variant={statusVariants[task.data.status]}>{task.data.status}</Badge>
      <Badge variant={priorityVariants[task.data.priority]}>{task.data.priority}</Badge>
      {task.data.due && (
        <span class="text-[var(--color-text)]">Due: {task.data.due.toISOString().split('T')[0]}</span>
      )}
    </div>

    <div class="border-t border-[var(--color-border)] pt-4">
      <h3 class="text-sm font-medium text-[var(--color-text-muted)] mb-2">Project</h3>
      <a href={`/projects/${task.data.project.id}/`} class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline">
        {displayName(projectEntry!)}
      </a>
    </div>

    <div class="border-t border-[var(--color-border)] pt-6 prose prose-invert max-w-none">
      <Content />
    </div>

    <RelatedContent title="Other Tasks in Project" items={siblingItems} />

    <Backlinks slug={task.id} />
  </div>
</PageTemplate>
