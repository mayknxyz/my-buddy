---
import { getCollection } from 'astro:content';
import Badge from '../../components/atoms/Badge.astro';
import FilterSelect from '../../components/atoms/FilterSelect.astro';
import FilterBar from '../../components/molecules/FilterBar.astro';
import PageTemplate from '../../components/templates/PageTemplate.astro';
import { displayName } from '../../utils/display';

const tasks = await getCollection('tasks');
const projects = await getCollection('projects');
const projectNames: Record<string, string> = Object.fromEntries(
  projects.map(p => [p.id, displayName(p)])
);

const statusVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  todo: 'neutral',
  'in-progress': 'warning',
  done: 'success',
  blocked: 'danger',
};

const priorityVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  low: 'neutral',
  medium: 'info',
  high: 'warning',
  urgent: 'danger',
};
---

<PageTemplate title="Tasks" description="All tasks"><div data-pagefind-ignore="all">
  <FilterBar searchPlaceholder="Search tasks...">
    <FilterSelect name="status" label="Status" options={[
      { value: 'todo', label: 'To Do' },
      { value: 'in-progress', label: 'In Progress' },
      { value: 'done', label: 'Done' },
      { value: 'blocked', label: 'Blocked' },
    ]} />
    <FilterSelect name="priority" label="Priority" options={[
      { value: 'low', label: 'Low' },
      { value: 'medium', label: 'Medium' },
      { value: 'high', label: 'High' },
      { value: 'urgent', label: 'Urgent' },
    ]} />
    <FilterSelect name="project" label="Project" options={
      projects.map(p => ({ value: p.id, label: displayName(p) }))
    } />
  </FilterBar>

  {tasks.length > 0 ? (
    <div class="rounded-lg border border-[var(--color-border)] overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-[var(--color-surface)] text-left text-[var(--color-text-muted)]">
            <th class="py-3 px-4 font-medium">ID</th>
            <th class="py-3 px-4 font-medium">Name</th>
            <th class="py-3 px-4 font-medium">Project</th>
            <th class="py-3 px-4 font-medium">Status</th>
            <th class="py-3 px-4 font-medium">Priority</th>
            <th class="py-3 px-4 font-medium">Due Date</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-[var(--color-border)]">
          {tasks.map((task, index) => (
            <tr class="hover:bg-[var(--color-surface-hover)] transition-colors" data-filter-status={task.data.status} data-filter-priority={task.data.priority} data-filter-project={task.data.project.id}>
              <td class="py-3 px-4 text-[var(--color-text-muted)]">{task.data.uid}</td>
              <td class="py-3 px-4">
                <a
                  href={`/tasks/${task.id}/`}
                  class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline"
                  data-focusable
                  data-index={index}
                  tabindex="0"
                >
                  {task.id.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/-/g, ' ')}
                </a>
              </td>
              <td class="py-3 px-4 text-[var(--color-text)]">{projectNames[task.data.project.id] || task.data.project.id.replace(/-/g, ' ')}</td>
              <td class="py-3 px-4">
                <Badge variant={statusVariants[task.data.status]}>{task.data.status}</Badge>
              </td>
              <td class="py-3 px-4">
                <Badge variant={priorityVariants[task.data.priority]}>{task.data.priority}</Badge>
              </td>
              <td class="py-3 px-4 text-[var(--color-text)]">
                {task.data.due ? task.data.due.toISOString().split('T')[0] : '-'}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <p class="text-[var(--color-text-muted)] text-center py-8">No tasks found.</p>
  )}
</div></PageTemplate>
