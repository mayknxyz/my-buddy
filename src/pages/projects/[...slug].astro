---
import { getCollection, render } from 'astro:content';
import Badge from '../../components/atoms/Badge.astro';
import Backlinks from '../../components/molecules/Backlinks.astro';
import RelatedContent from '../../components/molecules/RelatedContent.astro';
import PageTemplate from '../../components/templates/PageTemplate.astro';
import { refName } from '../../utils/display';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map(project => ({
    params: { slug: project.id },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);
const accounts = await getCollection('accounts');
const accountNames: Record<string, string> = Object.fromEntries(
  accounts.map(a => [a.id, a.data.title || a.id.replace(/-/g, ' ')])
);

const statusVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  planning: 'info',
  'in-progress': 'warning',
  done: 'success',
  paused: 'neutral',
};

const title = project.data.title || project.id.replace(/-/g, ' ');

// Related content
const priorityOrder: Record<string, number> = { urgent: 0, high: 1, medium: 2, low: 3 };

const allTasks = await getCollection('tasks');
const projectTasks = allTasks
  .filter(t => t.data.project.id === project.id)
  .sort((a, b) => {
    const pDiff = (priorityOrder[a.data.priority] ?? 3) - (priorityOrder[b.data.priority] ?? 3);
    if (pDiff !== 0) return pDiff;
    if (!a.data.due && !b.data.due) return 0;
    if (!a.data.due) return 1;
    if (!b.data.due) return -1;
    return a.data.due.getTime() - b.data.due.getTime();
  });

const allMeetings = await getCollection('meetings');
const projectMeetings = allMeetings
  .filter(m => m.data.project?.id === project.id)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const allJournals = await getCollection('journals');
const projectJournals = allJournals
  .filter(j => j.data.projects?.some(p => p.id === project.id))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const taskStatusVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  todo: 'neutral',
  'in-progress': 'warning',
  done: 'success',
  blocked: 'danger',
};

const relatedTasks = projectTasks.map(t => ({
  label: t.id.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/-/g, ' '),
  href: `/tasks/${t.id}/`,
  badge: t.data.priority,
  badgeVariant: ({ low: 'neutral' as const, medium: 'info' as const, high: 'warning' as const, urgent: 'danger' as const })[t.data.priority],
  meta: t.data.due ? `Due: ${t.data.due.toISOString().split('T')[0]}` : undefined,
}));

const relatedMeetings = projectMeetings.map(m => ({
  label: m.id.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/-/g, ' '),
  href: `/meetings/${m.id}/`,
  meta: m.data.date.toISOString().split('T')[0],
}));

const relatedJournals = projectJournals.map(j => ({
  label: j.data.date.toISOString().split('T')[0],
  href: `/journals/${j.id}/`,
  badge: j.data.mood,
  badgeVariant: j.data.mood ? ({ great: 'success' as const, good: 'success' as const, neutral: 'neutral' as const, bad: 'warning' as const, terrible: 'danger' as const })[j.data.mood] : undefined,
}));

const accountEntry = accounts.find(a => a.id === project.data.account.id);
const breadcrumbs = [
  ...(accountEntry ? [
    { label: 'Accounts', href: '/accounts/' },
    { label: accountEntry.data.title || accountEntry.id.replace(/-/g, ' '), href: `/accounts/${accountEntry.id}/` },
  ] : []),
  { label: 'Projects', href: '/projects/' },
  { label: title, href: `/projects/${project.id}/` },
];
---

<PageTemplate
  title={title}
  breadcrumbs={breadcrumbs}
>
  <meta data-pagefind-filter="collection[content]" content="projects" />
  <span data-pagefind-meta="title" style="display:none;">{title}</span>
  <div class="max-w-4xl space-y-6">
    <div class="flex flex-wrap items-center gap-3 text-sm text-[var(--color-text)]">
      <Badge variant={statusVariants[project.data.status]}>{project.data.status}</Badge>
      <span>Started: {project.data.start_date.toISOString().split('T')[0]}</span>
      {project.data.deadline && (
        <span>Deadline: {project.data.deadline.toISOString().split('T')[0]}</span>
      )}
    </div>

    <div class="border-t border-[var(--color-border)] pt-4">
      <h3 class="text-sm font-medium text-[var(--color-text-muted)] mb-2">Account</h3>
      <a href={`/accounts/${project.data.account.id}/`} class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline">
        {refName(project.data.account.id, accountNames)}
      </a>
    </div>

    {project.data.repo && (
      <div class="border-t border-[var(--color-border)] pt-4">
        <h3 class="text-sm font-medium text-[var(--color-text-muted)] mb-2">Repository</h3>
        <a href={`https://github.com/mayknxyz/${project.data.repo}`} target="_blank" rel="noopener noreferrer" class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline">
          mayknxyz/{project.data.repo}
        </a>
      </div>
    )}

    {project.data.budget && (
      <div class="border-t border-[var(--color-border)] pt-4">
        <h3 class="text-sm font-medium text-[var(--color-text-muted)] mb-2">Budget</h3>
        <p class="text-[var(--color-text)]">${project.data.budget.toLocaleString()}</p>
      </div>
    )}

    <div class="border-t border-[var(--color-border)] pt-6 prose prose-invert max-w-none">
      <Content />
    </div>

    <RelatedContent title="Tasks" items={relatedTasks} />
    <RelatedContent title="Meetings" items={relatedMeetings} />
    <RelatedContent title="Journals" items={relatedJournals} />

    <Backlinks slug={project.id} />
  </div>
</PageTemplate>
