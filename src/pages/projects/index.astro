---
import { getCollection } from 'astro:content';
import Badge from '../../components/atoms/Badge.astro';
import FilterSelect from '../../components/atoms/FilterSelect.astro';
import FilterBar from '../../components/molecules/FilterBar.astro';
import PageTemplate from '../../components/templates/PageTemplate.astro';
import { displayName, refName } from '../../utils/display';

const projects = await getCollection('projects');
const accounts = await getCollection('accounts');
const accountNames: Record<string, string> = Object.fromEntries(
  accounts.map(a => [a.id, a.data.title || a.id.replace(/-/g, ' ')])
);

const statusVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  planning: 'info',
  'in-progress': 'warning',
  done: 'success',
  paused: 'neutral',
};

const priorityVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  low: 'neutral',
  medium: 'info',
  high: 'warning',
  urgent: 'danger',
};
---

<PageTemplate title="Projects" description="All projects"><div data-pagefind-ignore="all">
  <FilterBar searchPlaceholder="Search projects...">
    <FilterSelect name="status" label="Status" options={[
      { value: 'planning', label: 'Planning' },
      { value: 'in-progress', label: 'In Progress' },
      { value: 'done', label: 'Done' },
      { value: 'paused', label: 'Paused' },
    ]} />
    <FilterSelect name="priority" label="Priority" options={[
      { value: 'low', label: 'Low' },
      { value: 'medium', label: 'Medium' },
      { value: 'high', label: 'High' },
      { value: 'urgent', label: 'Urgent' },
    ]} />
    <FilterSelect name="account" label="Account" options={
      accounts.map(a => ({ value: a.id, label: displayName(a) }))
    } />
  </FilterBar>

  {projects.length > 0 ? (
    <div class="rounded-lg border border-[var(--color-border)] overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-[var(--color-surface)] text-left text-[var(--color-text-muted)]">
            <th class="py-3 px-4 font-medium">ID</th>
            <th class="py-3 px-4 font-medium">Name</th>
            <th class="py-3 px-4 font-medium">Account</th>
            <th class="py-3 px-4 font-medium">Status</th>
            <th class="py-3 px-4 font-medium">Priority</th>
            <th class="py-3 px-4 font-medium">Due Date</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-[var(--color-border)]">
          {projects.map((project, index) => (
            <tr class="hover:bg-[var(--color-surface-hover)] transition-colors" data-filter-status={project.data.status} data-filter-priority={project.data.priority} data-filter-account={project.data.account.id}>
              <td class="py-3 px-4 text-[var(--color-text-muted)]">{project.data.uid}</td>
              <td class="py-3 px-4">
                <a
                  href={`/projects/${project.id}/`}
                  class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline"
                  data-focusable
                  data-index={index}
                  tabindex="0"
                >
                  {displayName(project)}
                </a>
              </td>
              <td class="py-3 px-4 text-[var(--color-text)]">{refName(project.data.account.id, accountNames)}</td>
              <td class="py-3 px-4">
                <Badge variant={statusVariants[project.data.status]}>{project.data.status}</Badge>
              </td>
              <td class="py-3 px-4">
                <Badge variant={priorityVariants[project.data.priority]}>{project.data.priority}</Badge>
              </td>
              <td class="py-3 px-4 text-[var(--color-text)]">
                {project.data.deadline ? project.data.deadline.toISOString().split('T')[0] : '-'}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <p class="text-[var(--color-text-muted)] text-center py-8">No projects found.</p>
  )}
</div></PageTemplate>
