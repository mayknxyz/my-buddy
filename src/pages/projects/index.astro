---
/**
 * Projects list page.
 * Displays all projects with status and priority filters,
 * sorted active-first, then by priority, then alphabetical.
 */
import BaseLayout from "@/components/templates/BaseLayout.astro";
import PageHeader from "@/components/templates/PageHeader.astro";
import Badge from "@/components/atoms/Badge.astro";
import FilterSelect from "@/components/atoms/FilterSelect.astro";
import FilterBar from "@/components/molecules/FilterBar.astro";
import EmptyState from "@/components/molecules/EmptyState.astro";
import SortHeader from "@/components/atoms/SortHeader.astro";
import { statusVariant, priorityLabel, formatCurrency, clientSlugFromId } from "@/lib/format";
import { getCollection } from "astro:content";

const statusFilter = Astro.url.searchParams.get("status");
const priorityFilter = Astro.url.searchParams.get("priority");
const sortField = Astro.url.searchParams.get("sort") ?? "";
const sortDir = Astro.url.searchParams.get("dir") ?? "asc";

const [allProjects, allClients] = await Promise.all([
  getCollection("projects").catch(() => []),
  getCollection("clients").catch(() => []),
]);

// Resolve client names for display
const clientNameMap = new Map<string, string>();
for (const c of allClients) {
  const slug = clientSlugFromId(c.id);
  clientNameMap.set(slug, c.data.name);
}

// Apply filters
let projects = allProjects;
if (statusFilter) projects = projects.filter((p) => p.data.status === statusFilter);
if (priorityFilter) projects = projects.filter((p) => p.data.priority === priorityFilter);

// Sort: custom column sort or default (status → priority → name)
const statusOrder: Record<string, number> = { active: 0, paused: 1, completed: 2, archived: 3 };
const priorityOrder: Record<string, number> = { high: 0, medium: 1, low: 2 };
const dir = sortDir === "desc" ? -1 : 1;

if (sortField) {
  projects = projects.sort((a, b) => {
    let cmp = 0;
    switch (sortField) {
      case "title":
        cmp = a.data.title.localeCompare(b.data.title);
        break;
      case "priority":
        cmp = (priorityOrder[a.data.priority] ?? 9) - (priorityOrder[b.data.priority] ?? 9);
        break;
      case "status":
        cmp = (statusOrder[a.data.status] ?? 9) - (statusOrder[b.data.status] ?? 9);
        break;
      case "budget":
        cmp = a.data.budget - b.data.budget;
        break;
      case "client": {
        const aClient = a.data.client ? (clientNameMap.get(a.data.client) ?? "") : "";
        const bClient = b.data.client ? (clientNameMap.get(b.data.client) ?? "") : "";
        cmp = aClient.localeCompare(bClient);
        break;
      }
    }
    return cmp * dir;
  });
} else {
  projects = projects.sort((a, b) => {
    const statusDiff = (statusOrder[a.data.status] ?? 9) - (statusOrder[b.data.status] ?? 9);
    if (statusDiff !== 0) return statusDiff;
    const priDiff = (priorityOrder[a.data.priority] ?? 9) - (priorityOrder[b.data.priority] ?? 9);
    if (priDiff !== 0) return priDiff;
    return a.data.title.localeCompare(b.data.title);
  });
}

const statusOptions = [
  { value: "active", label: "Active" },
  { value: "paused", label: "Paused" },
  { value: "completed", label: "Completed" },
  { value: "archived", label: "Archived" },
];

const priorityOptions = [
  { value: "high", label: "High" },
  { value: "medium", label: "Medium" },
  { value: "low", label: "Low" },
];
---

<BaseLayout title="Projects — my-buddy">
  <main class="mx-auto max-w-6xl p-6">
    <PageHeader title="Projects" count={projects.length} breadcrumbs={[{ label: "Home", href: "/" }, { label: "Projects" }]}>
      <FilterBar>
        <FilterSelect name="status" label="Status" options={statusOptions} selected={statusFilter ?? undefined} />
        <FilterSelect name="priority" label="Priority" options={priorityOptions} selected={priorityFilter ?? undefined} />
      </FilterBar>
    </PageHeader>

    {projects.length === 0 ? (
      <EmptyState title="No projects found" description={statusFilter || priorityFilter ? "Try changing the filters." : "Add your first project to get started."} />
    ) : (
      <div class="space-y-1">
        <div class="flex items-center justify-between px-4 py-2">
          <div class="flex items-center gap-6">
            <SortHeader field="title" label="Title" currentSort={sortField} currentDir={sortDir} baseUrl={Astro.url} />
            <SortHeader field="client" label="Client" currentSort={sortField} currentDir={sortDir} baseUrl={Astro.url} />
          </div>
          <div class="flex items-center gap-6">
            <SortHeader field="budget" label="Budget" currentSort={sortField} currentDir={sortDir} baseUrl={Astro.url} />
            <SortHeader field="priority" label="Priority" currentSort={sortField} currentDir={sortDir} baseUrl={Astro.url} />
            <SortHeader field="status" label="Status" currentSort={sortField} currentDir={sortDir} baseUrl={Astro.url} />
          </div>
        </div>
        {projects.map((project) => {
          const slug = clientSlugFromId(project.id);
          const clientName = project.data.client ? clientNameMap.get(project.data.client) : undefined;
          return (
            <a
              href={`/projects/${slug}`}
              data-navigable
              class="flex items-center justify-between rounded-lg border border-transparent px-4 py-3 hover:border-border hover:bg-surface-1"
            >
              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2">
                  <span class="font-medium">{project.data.title}</span>
                  {clientName && (
                    <span class="text-sm text-text-muted">{clientName}</span>
                  )}
                </div>
                {project.data.stack.length > 0 && (
                  <div class="mt-0.5 flex flex-wrap gap-1">
                    {project.data.stack.slice(0, 4).map((tag) => (
                      <span class="rounded bg-surface-2 px-1.5 py-0.5 text-xs text-text-muted">{tag}</span>
                    ))}
                    {project.data.stack.length > 4 && (
                      <span class="text-xs text-text-muted">+{project.data.stack.length - 4}</span>
                    )}
                  </div>
                )}
              </div>
              <div class="flex shrink-0 items-center gap-3 pl-4">
                {project.data.budget > 0 && (
                  <span class="text-sm tabular-nums text-text-muted">{formatCurrency(project.data.budget)}</span>
                )}
                <Badge variant={statusVariant(project.data.priority)}>{priorityLabel(project.data.priority)}</Badge>
                <Badge variant={statusVariant(project.data.status)}>{project.data.status}</Badge>
              </div>
            </a>
          );
        })}
      </div>
    )}
  </main>
</BaseLayout>
