---
import { getCollection } from 'astro:content';
import Badge from '../../components/atoms/Badge.astro';
import FilterSelect from '../../components/atoms/FilterSelect.astro';
import FilterBar from '../../components/molecules/FilterBar.astro';
import PageTemplate from '../../components/templates/PageTemplate.astro';
import { displayName } from '../../utils/display';

const meetings = await getCollection('meetings');
const sortedMeetings = meetings.sort((a, b) =>
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);
const accounts = await getCollection('accounts');
const projects = await getCollection('projects');

const typeVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  discovery: 'info',
  standup: 'neutral',
  review: 'warning',
  planning: 'success',
  retrospective: 'danger',
  other: 'neutral',
};
---

<PageTemplate title="Meetings" description="Meeting notes and action items"><div data-pagefind-ignore="all">
  <FilterBar searchPlaceholder="Search meetings...">
    <FilterSelect name="type" label="Type" options={[
      { value: 'discovery', label: 'Discovery' },
      { value: 'standup', label: 'Standup' },
      { value: 'review', label: 'Review' },
      { value: 'planning', label: 'Planning' },
      { value: 'retrospective', label: 'Retrospective' },
      { value: 'other', label: 'Other' },
    ]} />
    <FilterSelect name="account" label="Account" options={
      accounts.map(a => ({ value: a.id, label: displayName(a) }))
    } />
    <FilterSelect name="project" label="Project" options={
      projects.map(p => ({ value: p.id, label: displayName(p) }))
    } />
  </FilterBar>

  {sortedMeetings.length > 0 ? (
    <div class="rounded-lg border border-[var(--color-border)] overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-[var(--color-surface)] text-left text-[var(--color-text-muted)]">
            <th class="py-3 px-4 font-medium">ID</th>
            <th class="py-3 px-4 font-medium">Date</th>
            <th class="py-3 px-4 font-medium">Name</th>
            <th class="py-3 px-4 font-medium">Type</th>
            <th class="py-3 px-4 font-medium">Attendees</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-[var(--color-border)]">
          {sortedMeetings.map((meeting, index) => (
            <tr class="hover:bg-[var(--color-surface-hover)] transition-colors" data-filter-type={meeting.data.type} data-filter-account={meeting.data.account?.id || ''} data-filter-project={meeting.data.project?.id || ''}>
              <td class="py-3 px-4 text-[var(--color-text-muted)]">{meeting.data.uid}</td>
              <td class="py-3 px-4 text-[var(--color-text)]">
                {meeting.data.date.toISOString().split('T')[0]}
              </td>
              <td class="py-3 px-4">
                <a
                  href={`/meetings/${meeting.id}/`}
                  class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline"
                  data-focusable
                  data-index={index}
                  tabindex="0"
                >
                  {meeting.id.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/-/g, ' ')}
                </a>
              </td>
              <td class="py-3 px-4">
                <Badge variant={typeVariants[meeting.data.type]}>{meeting.data.type}</Badge>
              </td>
              <td class="py-3 px-4 text-[var(--color-text)]">
                {meeting.data.attendees.join(', ')}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <p class="text-[var(--color-text-muted)] text-center py-8">No meetings found.</p>
  )}
</div></PageTemplate>
