---
import { getCollection } from 'astro:content';
import Badge from '../../components/atoms/Badge.astro';
import FilterSelect from '../../components/atoms/FilterSelect.astro';
import FilterBar from '../../components/molecules/FilterBar.astro';
import PageTemplate from '../../components/templates/PageTemplate.astro';

const articles = await getCollection('kb');
const sortedArticles = articles.sort((a, b) => {
  const dateA = a.data.updated ? new Date(a.data.updated).getTime() : 0;
  const dateB = b.data.updated ? new Date(b.data.updated).getTime() : 0;
  return dateB - dateA;
});

const allTags = [...new Set(articles.flatMap(a => a.data.tags || []))].sort();
---

<PageTemplate title="Knowledge Base" description="Reference articles and documentation"><div data-pagefind-ignore="all">
  <FilterBar searchPlaceholder="Search knowledge base...">
    <FilterSelect name="tags" label="Tags" options={
      allTags.map(tag => ({ value: tag, label: tag }))
    } />
  </FilterBar>

  {sortedArticles.length > 0 ? (
    <div class="rounded-lg border border-[var(--color-border)] overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-[var(--color-surface)] text-left text-[var(--color-text-muted)]">
            <th class="py-3 px-4 font-medium">Title</th>
            <th class="py-3 px-4 font-medium">Tags</th>
            <th class="py-3 px-4 font-medium">Updated</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-[var(--color-border)]">
          {sortedArticles.map((article, index) => (
            <tr class="hover:bg-[var(--color-surface-hover)] transition-colors" data-filter-tags={(article.data.tags || []).join(',')}>
              <td class="py-3 px-4">
                <a
                  href={`/kb/${article.id}/`}
                  class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline"
                  data-focusable
                  data-index={index}
                  tabindex="0"
                >
                  {article.id.replace(/-/g, ' ')}
                </a>
              </td>
              <td class="py-3 px-4">
                {article.data.tags && article.data.tags.length > 0 ? (
                  <div class="flex flex-wrap gap-1">
                    {article.data.tags.map((tag: string) => (
                      <Badge variant="info">{tag}</Badge>
                    ))}
                  </div>
                ) : (
                  <span class="text-[var(--color-text-muted)]">-</span>
                )}
              </td>
              <td class="py-3 px-4 text-[var(--color-text)]">
                {article.data.updated ? article.data.updated.toISOString().split('T')[0] : '-'}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <p class="text-[var(--color-text-muted)] text-center py-8">No articles found.</p>
  )}
</div></PageTemplate>
