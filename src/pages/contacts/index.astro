---
import { getCollection } from 'astro:content';
import FilterSelect from '../../components/atoms/FilterSelect.astro';
import FilterBar from '../../components/molecules/FilterBar.astro';
import PageTemplate from '../../components/templates/PageTemplate.astro';
import { displayName, refName } from '../../utils/display';

const contacts = await getCollection('contacts');
const accounts = await getCollection('accounts');
const accountNames: Record<string, string> = Object.fromEntries(
  accounts.map(a => [a.id, a.data.title || a.id.replace(/-/g, ' ')])
);
---

<PageTemplate title="Contacts" description="All contacts"><div data-pagefind-ignore="all">
  <FilterBar searchPlaceholder="Search contacts...">
    <FilterSelect name="account" label="Account" options={
      accounts.map(a => ({ value: a.id, label: displayName(a) }))
    } />
    <FilterSelect name="primary" label="Primary" options={[
      { value: 'true', label: 'Primary' },
      { value: 'false', label: 'Not Primary' },
    ]} />
  </FilterBar>

  {contacts.length > 0 ? (
    <div class="rounded-lg border border-[var(--color-border)] overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-[var(--color-surface)] text-left text-[var(--color-text-muted)]">
            <th class="py-3 px-4 font-medium">ID</th>
            <th class="py-3 px-4 font-medium">First Name</th>
            <th class="py-3 px-4 font-medium">Last Name</th>
            <th class="py-3 px-4 font-medium">Role</th>
            <th class="py-3 px-4 font-medium">Account</th>
            <th class="py-3 px-4 font-medium">Email</th>
            <th class="py-3 px-4 font-medium">Phone</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-[var(--color-border)]">
          {contacts.map((contact, index) => (
            <tr class="hover:bg-[var(--color-surface-hover)] transition-colors" data-filter-account={contact.data.account.id} data-filter-primary={String(contact.data.is_primary)}>
              <td class="py-3 px-4 text-[var(--color-text-muted)]">{contact.data.uid}</td>
              <td class="py-3 px-4">
                <a
                  href={`/contacts/${contact.id}/`}
                  class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline"
                  data-focusable
                  data-index={index}
                  tabindex="0"
                >
                  {contact.data.first_name}
                </a>
              </td>
              <td class="py-3 px-4 text-[var(--color-text)]">{contact.data.last_name}</td>
              <td class="py-3 px-4 text-[var(--color-text)]">{contact.data.role || '-'}</td>
              <td class="py-3 px-4">
                <a href={`/accounts/${contact.data.account.id}/`} class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline">
                  {refName(contact.data.account.id, accountNames)}
                </a>
              </td>
              <td class="py-3 px-4 text-[var(--color-text)]">{contact.data.email || '-'}</td>
              <td class="py-3 px-4 text-[var(--color-text)]">{contact.data.phone || '-'}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <p class="text-[var(--color-text-muted)] text-center py-8">No contacts found.</p>
  )}
</div></PageTemplate>
