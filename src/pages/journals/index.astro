---
import { getCollection } from 'astro:content';
import Badge from '../../components/atoms/Badge.astro';
import FilterSelect from '../../components/atoms/FilterSelect.astro';
import FilterBar from '../../components/molecules/FilterBar.astro';
import PageTemplate from '../../components/templates/PageTemplate.astro';

const journals = await getCollection('journals');
const sortedJournals = journals.sort((a, b) =>
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

const allTags = [...new Set(sortedJournals.flatMap(j => j.data.tags || []))].sort();

const moodVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  great: 'success',
  good: 'success',
  neutral: 'neutral',
  bad: 'warning',
  terrible: 'danger',
};

const moodEmojis: Record<string, string> = {
  great: 'ðŸ˜„',
  good: 'ðŸ™‚',
  neutral: 'ðŸ˜',
  bad: 'ðŸ˜”',
  terrible: 'ðŸ˜¢',
};

function getTitle(id: string): string {
  const stripped = id.replace(/^\d{4}-\d{2}-\d{2}-?/, '').replace(/-/g, ' ');
  return stripped || 'Daily entry';
}

function getTags(tags: string[] | undefined): string {
  return tags && tags.length > 0 ? tags.join(', ') : '-';
}
---

<PageTemplate title="Journals" description="Personal notes and daily reflections"><div data-pagefind-ignore="all">
  <FilterBar searchPlaceholder="Search journals...">
    <FilterSelect name="mood" label="Mood" options={[
      { value: 'great', label: 'Great' },
      { value: 'good', label: 'Good' },
      { value: 'neutral', label: 'Neutral' },
      { value: 'bad', label: 'Bad' },
      { value: 'terrible', label: 'Terrible' },
    ]} />
    <FilterSelect name="tags" label="Tags" options={
      allTags.map(tag => ({ value: tag, label: tag }))
    } />
  </FilterBar>

  {sortedJournals.length > 0 ? (
    <div class="rounded-lg border border-[var(--color-border)] overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-[var(--color-surface)] text-left text-[var(--color-text-muted)]">
            <th class="py-3 px-4 font-medium">ID</th>
            <th class="py-3 px-4 font-medium">Date</th>
            <th class="py-3 px-4 font-medium">Title</th>
            <th class="py-3 px-4 font-medium">Mood</th>
            <th class="py-3 px-4 font-medium">Tags</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-[var(--color-border)]">
          {sortedJournals.map((journal, index) => (
            <tr class="hover:bg-[var(--color-surface-hover)] transition-colors" data-filter-mood={journal.data.mood || ''} data-filter-tags={(journal.data.tags || []).join(',')}>
              <td class="py-3 px-4 text-[var(--color-text-muted)]">{journal.data.uid}</td>
              <td class="py-3 px-4 text-[var(--color-text)]">
                {journal.data.date.toISOString().split('T')[0]}
              </td>
              <td class="py-3 px-4">
                <a
                  href={`/journals/${journal.id}/`}
                  class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline"
                  data-focusable
                  data-index={index}
                  tabindex="0"
                >
                  {getTitle(journal.id)}
                </a>
              </td>
              <td class="py-3 px-4">
                {journal.data.mood && (
                  <Badge variant={moodVariants[journal.data.mood]}>
                    {moodEmojis[journal.data.mood]} {journal.data.mood}
                  </Badge>
                )}
                {!journal.data.mood && <span class="text-[var(--color-text-muted)]">-</span>}
              </td>
              <td class="py-3 px-4 text-[var(--color-text)]">{getTags(journal.data.tags)}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <p class="text-[var(--color-text-muted)] text-center py-8">No journal entries found.</p>
  )}
</div></PageTemplate>
