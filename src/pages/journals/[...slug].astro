---
import { getCollection, render } from 'astro:content';
import Badge from '../../components/atoms/Badge.astro';
import Backlinks from '../../components/molecules/Backlinks.astro';
import PageTemplate from '../../components/templates/PageTemplate.astro';
import { displayName } from '../../utils/display';

export async function getStaticPaths() {
  const journals = await getCollection('journals');
  return journals.map(journal => ({
    params: { slug: journal.id },
    props: { journal },
  }));
}

const { journal } = Astro.props;
const { Content } = await render(journal);
const allProjects = await getCollection('projects');
const projectNames: Record<string, string> = Object.fromEntries(
  allProjects.map(p => [p.id, displayName(p)])
);

const moodVariants: Record<string, 'success' | 'warning' | 'danger' | 'info' | 'neutral'> = {
  great: 'success',
  good: 'success',
  neutral: 'neutral',
  bad: 'warning',
  terrible: 'danger',
};

const moodEmojis: Record<string, string> = {
  great: 'ğŸ˜„',
  good: 'ğŸ™‚',
  neutral: 'ğŸ˜',
  bad: 'ğŸ˜”',
  terrible: 'ğŸ˜¢',
};

const title = new Date(journal.data.date).toLocaleDateString('en-US', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<PageTemplate
  title={title}
  breadcrumbs={[
    { label: 'Journals', href: '/journals/' },
    { label: title, href: `/journals/${journal.id}/` },
  ]}
>
  <meta data-pagefind-filter="collection[content]" content="journals" />
  <span data-pagefind-meta="title" style="display:none;">{new Date(journal.data.date).toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  })}</span>
  <div class="max-w-4xl space-y-6">
    <div class="flex flex-wrap items-center gap-3">
      {journal.data.mood && (
        <Badge variant={moodVariants[journal.data.mood]}>
          {moodEmojis[journal.data.mood]} {journal.data.mood}
        </Badge>
      )}
      {journal.data.tags?.map((tag: string) => (
        <span class="text-sm text-[var(--color-text)]">#{tag}</span>
      ))}
    </div>

    {journal.data.projects && journal.data.projects.length > 0 && (
      <div class="border-t border-[var(--color-border)] pt-4">
        <h3 class="text-sm font-medium text-[var(--color-text-muted)] mb-2">Related Projects</h3>
        <ul class="flex flex-wrap gap-2">
          {journal.data.projects.map((project: { id: string }) => (
            <li>
              <a href={`/projects/${project.id}/`} class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] hover:underline text-sm">
                {projectNames[project.id] || project.id.replace(/-/g, ' ')}
              </a>
            </li>
          ))}
        </ul>
      </div>
    )}

    <div class="border-t border-[var(--color-border)] pt-6 prose prose-invert max-w-none">
      <Content />
    </div>

    <Backlinks slug={journal.id} />
  </div>
</PageTemplate>
